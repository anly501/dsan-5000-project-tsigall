team,
season,
correct_rate = should_go,
pct,
epa, count)
kable(head(leverage_win_pct))
leverage_win_pct <- leverage_win_pct %>%
mutate(z_wins = as.numeric(scale(pct)),
z_correct = as.numeric(scale(correct_rate)),
z_epa = as.numeric(scale(epa)),
above_mean_wins = if_else(z_wins > 0, 1, 0),
above_mean_correct = if_else(z_correct > 0, 1, 0),
above_mean_epa = if_else(z_epa > 0, 1, 0))
kable(head(leverage_win_pct, 10))
cross_tab1 <- as.data.frame(table(leverage_win_pct$above_mean_wins,
leverage_win_pct$above_mean_correct)) %>%
rename(above_mean_wins = Var1,
above_mean_correct = Var2)
cross_tab2 <- as.data.frame(table(leverage_win_pct$above_mean_epa,
leverage_win_pct$above_mean_correct)) %>%
rename(above_mean_epa = Var1,
above_mean_correct = Var2)
ggplot(cross_tab1, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_wins))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean Wins") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
ggplot(cross_tab2, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_epa))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean 4th Down EPA") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
View(coaches)
View(coach_record)
View(coaches)
View(coach_record)
View(fourth_decisions)
View(leverage_decisions)
View(leverage_win_pct)
View(coaches)
leverage_win_pct <- coaches %>%
inner_join(leverage_decisions, by = c("coach", "team" = "posteam", "season")) %>%
select(coach,
team,
season,
correct_rate = should_go,
pct,
epa, count)
View(leverage_decisions)
save(leverage_win_pct, file = "leverage_win_pct.Rdata")
write_csv(leverage_win_pct, "leverage_win_pct.csv")
reticulate::repl_python()
library(nflverse)
library(tidyverse)
library(ggplot2)
library(grid)
library(reticulate)
library(kableExtra)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(scales)
options(digits = 3)
load("clean_data.Rdata")
raw_games <- nflreadr::load_schedules()
home_games <- raw_games %>%
filter(season > 2015 & season < 2023,
game_type == "REG") %>%
dplyr::select(season,
result,
coach = home_coach) %>%
dplyr::mutate(win = if_else(result > 0, 1, 0),
loss = if_else(result < 0, 1, 0),
tie = if_else(result == 0, 1, 0)) %>%
dplyr::group_by(coach,
season) %>%
summarize(wins = sum(win),
losses = sum(loss),
ties = sum(tie))
away_games <- raw_games %>%
filter(season > 2015 & season < 2023,
game_type == "REG") %>%
dplyr::select(season,
result,
coach = away_coach) %>%
dplyr::mutate(win = if_else(result < 0, 1, 0),
loss = if_else(result > 0, 1, 0),
tie = if_else(result == 0, 1, 0)) %>%
dplyr::group_by(coach,
season) %>%
summarize(wins = sum(win),
losses = sum(loss),
ties = sum(tie))
coach_record <- away_games %>%
left_join(home_games, by = c("coach", "season")) %>%
mutate(wins = wins.x + wins.y,
losses = losses.x + losses.y,
ties = ties.x + ties.y) %>%
select(coach, season, wins, losses, ties)
rm(home_games, away_games, raw_games)
coaches <- fourth_decisions %>%
dplyr::select(coach, team = posteam, season, EPA) %>%
left_join(coach_record, by = c("coach", "season"))
coaches <- coaches %>%
mutate(pct = (wins + ties * 0.5) / (wins + losses + ties)) %>%
select(coach,
team,
season,
pct,
epa = EPA)
win_pct <- coaches %>%
left_join(fourth_decisions, by = c("coach", "team" = "posteam", "season")) %>%
select(coach,
team,
season,
correct_rate = should_go,
pct,
epa)
kable(head(win_pct, 10))
win_pct <- win_pct %>%
mutate(z_wins = as.numeric(scale(pct)),
z_correct = as.numeric(scale(correct_rate)),
z_epa = as.numeric(scale(epa)),
above_mean_wins = if_else(z_wins > 0, 1, 0),
above_mean_correct = if_else(z_correct > 0, 1, 0),
above_mean_epa = if_else(z_epa > 0, 1, 0))
kable(head(win_pct, 10))
cross_tab1 <- as.data.frame(table(win_pct$above_mean_wins,
win_pct$above_mean_correct)) %>%
rename(above_mean_wins = Var1,
above_mean_correct = Var2)
cross_tab2 <- as.data.frame(table(win_pct$above_mean_epa,
win_pct$above_mean_correct)) %>%
rename(above_mean_epa = Var1,
above_mean_correct = Var2)
ggplot(cross_tab1, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_wins))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean 4th Down Wins") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
ggplot(cross_tab2, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_epa))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean 4th Down EPA") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
leverage <- fourth_downs %>%
mutate(wp_change = wp_succeed - wp_fail,
coach = if_else(posteam_type == "home", home_coach, away_coach)) %>%
select(season,
coach,
posteam,
defteam,
qtr,
time,
ydstogo,
yardline_100,
posteam_score,
defteam_score,
go_boost,
go,
epa,
wp,
wp_fail,
wp_succeed,
wp_change,
fg_make_prob,
miss_fg_wp,
make_fg_wp,
punt_wp) %>%
filter(abs(wp_change) > .1,
qtr == 4)
kable(head(leverage))
leverage_decisions <- leverage %>%
mutate(should_go = ifelse((go_boost > 0),
(if_else(go == 100, 1, 0)),
NA),
shouldnt_go = ifelse((go_boost < 0),
(if_else(go == 0, 1, 0)),
NA)) %>%
select(season, coach, posteam, ydstogo, yardline_100, go_boost, should_go, shouldnt_go, go, epa) %>%
group_by(coach, posteam, season) %>%
summarize(should_go =
sum(should_go == 1, na.rm = TRUE) /
(sum(should_go == 0 | should_go == 1, na.rm = TRUE)),
shouldnt_go =
sum(shouldnt_go == 1, na.rm = TRUE) /
(sum(shouldnt_go == 0 | shouldnt_go == 1, na.rm = TRUE)),
EPA = mean(epa),
count = n()) %>%
filter(count > 5) %>%
ungroup()
coaches <- fourth_decisions %>%
dplyr::select(coach, team = posteam, season, EPA) %>%
left_join(coach_record, by = c("coach", "season")) %>%
mutate(pct = (wins + ties * 0.5) / (wins + losses + ties)) %>%
select(coach,
team,
season,
pct,
epa = EPA) %>%
group_by(coach, team, season) %>%
summarise(pct = mean(pct, na.rm = TRUE),
epa = mean(epa, na.rm = TRUE)) %>%
ungroup()
leverage_win_pct <- coaches %>%
inner_join(leverage_decisions, by = c("coach", "team" = "posteam", "season")) %>%
select(coach,
team,
season,
correct_rate = should_go,
pct,
epa, count)
kable(head(leverage_win_pct))
leverage_win_pct <- leverage_win_pct %>%
mutate(z_wins = as.numeric(scale(pct)),
z_correct = as.numeric(scale(correct_rate)),
z_epa = as.numeric(scale(epa)),
above_mean_wins = if_else(z_wins > 0, 1, 0),
above_mean_correct = if_else(z_correct > 0, 1, 0),
above_mean_epa = if_else(z_epa > 0, 1, 0))
kable(head(leverage_win_pct, 10))
cross_tab1 <- as.data.frame(table(leverage_win_pct$above_mean_wins,
leverage_win_pct$above_mean_correct)) %>%
rename(above_mean_wins = Var1,
above_mean_correct = Var2)
cross_tab2 <- as.data.frame(table(leverage_win_pct$above_mean_epa,
leverage_win_pct$above_mean_correct)) %>%
rename(above_mean_epa = Var1,
above_mean_correct = Var2)
ggplot(cross_tab1, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_wins))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean Wins") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
ggplot(cross_tab2, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_epa))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean 4th Down EPA") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
library(nflverse)
library(tidyverse)
library(ggplot2)
library(grid)
library(reticulate)
library(kableExtra)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(scales)
options(digits = 3)
load("clean_data.Rdata")
raw_games <- nflreadr::load_schedules()
home_games <- raw_games %>%
filter(season > 2015 & season < 2023,
game_type == "REG") %>%
dplyr::select(season,
result,
coach = home_coach) %>%
dplyr::mutate(win = if_else(result > 0, 1, 0),
loss = if_else(result < 0, 1, 0),
tie = if_else(result == 0, 1, 0)) %>%
dplyr::group_by(coach,
season) %>%
summarize(wins = sum(win),
losses = sum(loss),
ties = sum(tie))
away_games <- raw_games %>%
filter(season > 2015 & season < 2023,
game_type == "REG") %>%
dplyr::select(season,
result,
coach = away_coach) %>%
dplyr::mutate(win = if_else(result < 0, 1, 0),
loss = if_else(result > 0, 1, 0),
tie = if_else(result == 0, 1, 0)) %>%
dplyr::group_by(coach,
season) %>%
summarize(wins = sum(win),
losses = sum(loss),
ties = sum(tie))
coach_record <- away_games %>%
left_join(home_games, by = c("coach", "season")) %>%
mutate(wins = wins.x + wins.y,
losses = losses.x + losses.y,
ties = ties.x + ties.y) %>%
select(coach, season, wins, losses, ties)
rm(home_games, away_games, raw_games)
coaches <- fourth_decisions %>%
dplyr::select(coach, team = posteam, season, EPA) %>%
left_join(coach_record, by = c("coach", "season"))
coaches <- coaches %>%
mutate(pct = (wins + ties * 0.5) / (wins + losses + ties)) %>%
select(coach,
team,
season,
pct,
epa = EPA)
win_pct <- coaches %>%
left_join(fourth_decisions, by = c("coach", "team" = "posteam", "season")) %>%
select(coach,
team,
season,
correct_rate = should_go,
pct,
epa)
kable(head(win_pct, 10))
win_pct <- win_pct %>%
mutate(z_wins = as.numeric(scale(pct)),
z_correct = as.numeric(scale(correct_rate)),
z_epa = as.numeric(scale(epa)),
above_mean_wins = if_else(z_wins > 0, 1, 0),
above_mean_correct = if_else(z_correct > 0, 1, 0),
above_mean_epa = if_else(z_epa > 0, 1, 0))
kable(head(win_pct, 10))
cross_tab1 <- as.data.frame(table(win_pct$above_mean_wins,
win_pct$above_mean_correct)) %>%
rename(above_mean_wins = Var1,
above_mean_correct = Var2)
cross_tab2 <- as.data.frame(table(win_pct$above_mean_epa,
win_pct$above_mean_correct)) %>%
rename(above_mean_epa = Var1,
above_mean_correct = Var2)
ggplot(cross_tab1, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_wins))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean 4th Down Wins") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
ggplot(cross_tab2, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_epa))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean 4th Down EPA") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
leverage <- fourth_downs %>%
mutate(wp_change = wp_succeed - wp_fail,
coach = if_else(posteam_type == "home", home_coach, away_coach)) %>%
select(season,
coach,
posteam,
defteam,
qtr,
time,
ydstogo,
yardline_100,
posteam_score,
defteam_score,
go_boost,
go,
epa,
wp,
wp_fail,
wp_succeed,
wp_change,
fg_make_prob,
miss_fg_wp,
make_fg_wp,
punt_wp) %>%
filter(abs(wp_change) > .1,
qtr == 4)
kable(head(leverage))
leverage_decisions <- leverage %>%
mutate(should_go = ifelse((go_boost > 0),
(if_else(go == 100, 1, 0)),
NA),
shouldnt_go = ifelse((go_boost < 0),
(if_else(go == 0, 1, 0)),
NA)) %>%
select(season, coach, posteam, ydstogo, yardline_100, go_boost, should_go, shouldnt_go, go, epa) %>%
group_by(coach, posteam, season) %>%
summarize(should_go =
sum(should_go == 1, na.rm = TRUE) /
(sum(should_go == 0 | should_go == 1, na.rm = TRUE)),
shouldnt_go =
sum(shouldnt_go == 1, na.rm = TRUE) /
(sum(shouldnt_go == 0 | shouldnt_go == 1, na.rm = TRUE)),
EPA = mean(epa),
count = n()) %>%
filter(count > 5) %>%
ungroup()
coaches <- fourth_decisions %>%
dplyr::select(coach, team = posteam, season, EPA) %>%
left_join(coach_record, by = c("coach", "season")) %>%
mutate(pct = (wins + ties * 0.5) / (wins + losses + ties)) %>%
select(coach,
team,
season,
pct,
epa = EPA) %>%
group_by(coach, team, season) %>%
summarise(pct = mean(pct, na.rm = TRUE),
epa = mean(epa, na.rm = TRUE)) %>%
ungroup()
leverage_win_pct <- coaches %>%
inner_join(leverage_decisions, by = c("coach", "team" = "posteam", "season")) %>%
select(coach,
team,
season,
correct_rate = should_go,
pct,
epa, count)
kable(head(leverage_win_pct))
leverage_win_pct <- leverage_win_pct %>%
mutate(z_wins = as.numeric(scale(pct)),
z_correct = as.numeric(scale(correct_rate)),
z_epa = as.numeric(scale(epa)),
above_mean_wins = if_else(z_wins > 0, 1, 0),
above_mean_correct = if_else(z_correct > 0, 1, 0),
above_mean_epa = if_else(z_epa > 0, 1, 0))
kable(head(leverage_win_pct, 10))
cross_tab1 <- as.data.frame(table(leverage_win_pct$above_mean_wins,
leverage_win_pct$above_mean_correct)) %>%
rename(above_mean_wins = Var1,
above_mean_correct = Var2)
cross_tab2 <- as.data.frame(table(leverage_win_pct$above_mean_epa,
leverage_win_pct$above_mean_correct)) %>%
rename(above_mean_epa = Var1,
above_mean_correct = Var2)
ggplot(cross_tab1, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_wins))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean Wins") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
ggplot(cross_tab2, aes(x = above_mean_correct, y = Freq, fill = factor(above_mean_epa))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean 4th Down EPA") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
save(leverage_win_pct, file = "leverage_win_pct.Rdata")
write_csv(leverage_win_pct, "leverage_win_pct.csv")
reticulate::repl_python()
View(fourth_downs)
View(leverage_decisions)
leverage_win_pct <- coaches %>%
inner_join(leverage_decisions, by = c("coach", "team" = "posteam", "season")) %>%
select(coach,
team,
season,
should_go,
shouldnt_go,
pct,
epa, count)
View(leverage_win_pct)
leverage_win_pct <- leverage_win_pct %>%
mutate(z_wins = as.numeric(scale(pct)),
z_should = as.numeric(scale(should_go)),
z_shouldnt = as.numeric(scale(shouldnt_go)),
z_epa = as.numeric(scale(epa)),
above_mean_wins = if_else(z_wins > 0, 1, 0),
above_mean_should = if_else(z_should > 0, 1, 0),
above_mean_shouldnt = if_else(z_shouldnt > 0, 1, 0)
above_mean_epa = if_else(z_epa > 0, 1, 0))
leverage_win_pct <- leverage_win_pct %>%
mutate(z_wins = as.numeric(scale(pct)),
z_should = as.numeric(scale(should_go)),
z_shouldnt = as.numeric(scale(shouldnt_go)),
z_epa = as.numeric(scale(epa)),
above_mean_wins = if_else(z_wins > 0, 1, 0),
above_mean_should = if_else(z_should > 0, 1, 0),
above_mean_shouldnt = if_else(z_shouldnt > 0, 1, 0),
above_mean_epa = if_else(z_epa > 0, 1, 0))
kable(head(leverage_win_pct, 10))
cross_tab1 <- as.data.frame(table(leverage_win_pct$above_mean_wins,
leverage_win_pct$above_mean_should)) %>%
rename(above_mean_wins = Var1,
above_mean_should = Var2)
cross_tab2 <- as.data.frame(table(leverage_win_pct$above_mean_epa,
leverage_win_pct$above_mean_should)) %>%
rename(above_mean_epa = Var1,
above_mean_should = Var2)
ggplot(cross_tab1, aes(x = above_mean_should, y = Freq, fill = factor(above_mean_wins))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down",
y = "Frequency",
fill = "Above Mean Wins") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
ggplot(cross_tab1, aes(x = above_mean_should, y = Freq, fill = factor(above_mean_wins))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down (Go for it scenarios)",
y = "Frequency",
fill = "Above Mean Wins") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
ggplot(cross_tab2, aes(x = above_mean_should, y = Freq, fill = factor(above_mean_epa))) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "Above Mean Correct Decision Rate on 4th Down (Go for it scenarios)",
y = "Frequency",
fill = "Above Mean 4th Down EPA") +
scale_fill_manual(values = c("0" = "orange", "1" = "blue"), labels = c("False", "True")) +
theme(legend.position = "top")
save(leverage_win_pct, file = "leverage_win_pct.Rdata")
write_csv(leverage_win_pct, "leverage_win_pct.csv")
reticulate::repl_python()
